<?php


/**
 * Initial function to being import script
 * @return unknown
 */
function simport_import(){
  vsite_include('vsiteapi');
  $roles = variable_get('scholar_manager_role', 'scholar admin');
  $old_sites_table = 'node_export_admin_scholar';

  //first create the new vsites
  $sql = db_query("SELECT * FROM $old_sites_table");
  while ($data = db_fetch_object($sql)) {
   
      //get the old site node object
      $old = unserialize($data ->nodedata); //dpm($old);
  
      //set the domain for the new site
  	$domain = $old -> title;
  
 	//collect parameters to create new vsite
  	$name = db_result(db_query("SELECT name from {users_old} WHERE uid = %d", (int)$old ->uid));
  	$mail = db_result(db_query("SELECT mail from {users_old} WHERE uid = %d", (int)$old->uid));
  	$password_hash = db_result(db_query("SELECT pass from {users_old} WHERE uid = %d", (int)$old->uid));
  	
  	//create user
  	$user = simport_create_user($name, $mail, $password_hash, $roles);
  	 	 	
  	//create site 
  	$new_site_info = simport_create_site($user, $domain);
  	
  	//write to the simport table mapping old site to new site
  	$sql_map_sites = db_query("INSERT INTO {simport} (old, new) VALUES (%d, %d)", (int)$old -> nid, (int)$new_site_info ->nid);
  	
  	//get a spaces object for new site so we can modify and save with the functions below
  	$new = spaces_load ( 'og', $new_site_info ->nid, TRUE );
  	
  	dpm($old);
   	
  	//set theme
  	simport_set_theme($old, $new);
  	 	 	
      //set logo
  	simport_set_logo($old, $new);
  	
  	
  	
      //just iterate once for testing purposes - REMOVE THIS WHEN DONE TESTING
     // return false;
      
      //save all the changes/additions to the space
      spaces_save($new);
  }
  return false;
    //loading each content type
    /*$types =vsite_content_types();
       //temp to test - should be removed
       $types = array('link');
      foreach ($types as $type){
        $table = 'node_export_scholar_' . $type;
        $sql = db_query("SELECT * FROM {$table}");
        while ($data = db_fetch_object($sql)) {
           $old = unserialize($data ->nodedata);
           $new = new stdClass();    	
        }
      }*/
    
    
    
    //set frontpage last
  	simport_set_frontpage($old, $new);
}

/**
 * Create the user
 */
function simport_create_user($name, $mail, $password_hash, $roles){
  install_include(array( 'user' ));  
  $password =  user_password();
  $user = install_add_user($name, $password, $mail, $roles = array($roles), $status = 1);

  if (!$user){
    //TODO: add watchdog message
    //watchdog();
    }
    
  else{
    //change the password back to the original
    $sql_revert_password = db_query("UPDATE {users} SET pass = '%s' WHERE uid = %d", $password_hash, (int)$user ->uid);
  } 
  //return the new user object
  return $user;
}

/**
 * Create the site
 */
function simport_create_site($user, $domain){
  vsite_include('vsiteapi');
  //create the site
  return vsite_vsite_create($user->name, $user->mail, $domain);
}

/**
 * 
 * @param $old og node from the old site
 * @param $new the new vsite
 */
function simport_set_theme($old, &$new){
  
  $og_theme_map = array(
  'fac01' => 'scholar_theme_06',
  'fac02' => 'scholar_theme_01',
  'fac03' =>'scholar_theme_03',
  'fac04' => 'scholar_theme_06',
  'fac05' => 'scholar_theme_05',
  'fac06' => 'scholar_theme_04',
  'fac07' => 'scholar_theme_07',  
  );
  //set the new theme
  $new->settings['theme'] = $og_theme_map[$old -> og_theme];
}

/**
 * Set the frontpage value
 *
 * @param unknown_type $old
 * @param unknown_type $new
 */
function simport_import_frontpage($old, &$new){

 $frontpage_old =  unserialize(db_result(db_query("SELECT value FROM {og_settings} WHERE name = '%s' and nid = %d", 'scholar_admin_site_front_node', (int)$old -> nid)));
 
 //get nid the mapping
 $frontpage = db_result(db_query("SELECT new from {simport} WHERE old = %d", (int)$frontpage_old));
  
 //TODO: Not sure yet how to deal with this???
 $new->settings['front']['frontpage'] =  '';  //$frontpage;
  
}

function simport_set_logo($old, &$new){

}


function simport_set_shield($old, &$new){
  
}




