<?php


function scholarregister_menu(){
  $items = array();
  $items['site/register'] = array(
    'title' => 'Create your web site',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('scholarregister_signup_form'),
    'file' => 'scholarregister.pages.inc',
    'access arguments' => array('access content'),
  );
  
  $items['site/r'] = array(
    'title' => 'Create your web site',

    'page callback' => 'drupal_get_form',
    'page arguments' => array('try_modalcontent'),
    //'page arguments' => array('try')
    //'file' => 'scholarregister.pages.inc',
    'access arguments' => array('access content'),
  );

  $items['scholarregister/domain_js'] = array(
    'title' => 'Create your web site',
    'page callback' => 'scholarregister_domain_js',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  
  $items['scholarregister/mail_js'] = array(
    'title' => 'Create your web site',
    'page callback' => 'scholarregister_mail_js',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  
  
  $items['scholarregister/name_js'] = array(
    'title' => 'Create your web site',
    'page callback' => 'scholarregister_name_js',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function scholarregister_name_js() {
  $name = $_POST ['ctools_changed'];
  scholarregister_validate_name($name);
  $message = 'available';
  
  // does the username validates
  if ($error = user_validate_name($name)) {
    scholarregister_ctools_message('#name-suffix', $error); // exits
  }
  

  // is it available
  $query = "SELECT name FROM {users} WHERE name='%s'";
  $existing_user = db_result(db_query($query, $name));
  if ($existing_user) {
     scholarregister_ctools_message('#name-suffix', 'username taken'); // exits
  }
  
  // just to make things easier, check if this uname is == to any purl
  $query = "SELECT value FROM {purl} WHERE value='%s'";
  $existing_purl = db_result(db_query($query, $name));
  if (!$existing_purl) {
     scholarregister_ctools_message('#name-suffix', 'username taken'); // exits
  }
  
  // ok then .. it's good and available
  scholarregister_ctools_message('#name-suffix', $message); // exits
}

function scholarregister_mail_js() {
  $mail = $_POST['ctools_changed'];
  scholarregister_validate_mail($mail);
  // check email availability / correctnes (user_validate)

  ctools_include ( 'ajax' );
  ctools_add_js ( 'ajax-responder' );
  $commands = array ();
  $commands [] = ctools_ajax_command_html ( '#mail-suffix', 'available' );
  ctools_ajax_render ( $commands ); 
}

function scholarregister_domain_js() {
  $domain = $_POST['ctools_changed'];
  
  // TODO check availability / correctness of the domain (purl)
  
  ctools_include ( 'ajax' );
  ctools_add_js ( 'ajax-responder' );
  $commands = array ();
  $commands [] = ctools_ajax_command_html ( '#domain-suffix', 'available');
  ctools_ajax_render ( $commands );
}

function scholarregister_r(){
  drupal_add_css ( drupal_get_path ( 'module', 'scholarregister' ) . '/scholarregister.css' );
  ctools_include('modal');
  ctools_include('form');
  ctools_include('ajax');
  $form_state = array(
    '#ajax' => TRUE,
    '#redirect' => FALSE,
  );
  $output .= ctools_modal_form_wrapper('user_register', &$form_state);
  //$output .= drupal_get_form ( 'scholarregister_signup_form' );
  
  // we can just return the $output or, if we want to not print
  // blocks etc., use theme_page(..., FALSE) see phptemplate.engine
  

  //return $output;
  print theme ( 'page', $output, FALSE );
}

/**
 * the callback for site/register menu
 */
function  scholarregister_register() {
  drupal_add_css ( drupal_get_path ( 'module', 'scholarregister' ) . '/scholarregister.css' );
  ctools_include('modal');
  ctools_include('form');
  ctools_include('ajax');
  $form_state = array(
    '#ajax' => TRUE,
    '#redirect' => FALSE,
  );
  $output .= ctools_modal_form_wrapper('scholarregister_signup_form', &$form_state);
  //$output .= drupal_get_form ( 'scholarregister_signup_form' );
  
  // we can just return the $output or, if we want to not print
  // blocks etc., use theme_page(..., FALSE) see phptemplate.engine
  

  //return $output;
  print theme ( 'page', $output, FALSE );
}

function scholarregister_validate_name($name) {
  $message = 'available';
  
  // does the username validates
  if ($error = user_validate_name($name)) {
    scholarregister_ctools_message('#name-suffix', $error); // exits
  }
  

  // is it available
  $query = "SELECT name FROM {users} WHERE name='%s'";
  $existing_user = db_result(db_query($query, $name));
  dpm($existing_user);
  if ($existing_user) {
     scholarregister_ctools_message('#name-suffix', 'username taken'); // exits
  }
  
  // just to make things easier, check if this uname is == to any purl
  $query = "SELECT value FROM {purl} WHERE value='%s'";
  $existing_purl = db_result(db_query($query, $name));
  if ($existing_purl) {
     scholarregister_ctools_message('#name-suffix', 'username taken'); // exits
  }
  
  // ok then .. it's good and available
  scholarregister_ctools_message('#name-suffix', $message); // exits
}



function scholarregister_validate_mail($mail) {
  // Validate the e-mail address:
  if ($error = user_validate_mail($mail)) {
    scholarregister_ctools_message('#mail-suffix', $error); // exits
  }
}



function scholarregister_ctools_message($id, $message){
  ctools_include ( 'ajax' );
  ctools_add_js ( 'ajax-responder' );
  $commands = array ();
  $commands [] = ctools_ajax_command_html ( $id, $message);
  ctools_ajax_render ( $commands );
}


/**
 * hook form_alter
 */
function scholarregister_form_alter(&$form, $form_state, $form_id) {
    if ($form_id == 'user_register') {
  ctools_include('modal');
  ctools_include('form');
  ctools_include('ajax');
  $form_state = array(
    '#ajax' => TRUE,
    '#redirect' => FALSE,
  );
   // print_r($form);
  $form = ctools_modal_form_wrapper('user_register', &$form_state);
  

   // print_r($form);

   $form['submit']['#attributes'] = array('class' => 'ctools-use-ajax');
   $form['#submit'][] = 'scholarregister_signup_form_submit';
   //unset($form['submit']);
  }
}


function try_modalcontent(){
  return 'hello';
  ctools_include('ajax');
  ctools_include('modal');
  ctools_include('form');

  $form_state = array(
    're_render' => TRUE,
    'title' => t('Display settings'),
   // 'ajax' => TRUE,
  );
 
  $output = ctools_modal_form_wrapper('user_register', $form_state);
  
  return $output;
  if (empty($output)) {
    $output = array();
    $output[] = ctools_modal_command_dismiss();
  }

  ctools_ajax_render($output);

}



