<?php
/**
 * Basic tests for OS Pages.
 */
class VsiteAccessTest extends DrupalWebTestCase {

  /**
   * Test info.
   */
  public static function getInfo(){
    return array(
        'name' => t('Vsite: Access'),
        'description' => t('Test Access senarios for multi-tenant sites.'),
        'group' => t('vsite')
    );
  }

  /**
   * Set up test.
   */
  public function setUp(){
    parent::setUp('context', 'purl', 'spaces', 'og', 'spaces_og', 'os', 'entityreference', 'features', 'os_link','vsite','vsite_domain');
  }

  /**
   * Run context test.
   */
  public function testAddNode(){
    
  	//Create A Group Node
    $group_node = array(
        'title' => 'My Test Site',
        'type' => 'vsite',
        'purl' => 'test_site',
    );
    $group = $this->drupalCreateNode($group_node);
  	
    //Create Link Node
    $link_node = array(
        'title' => 'A Test Link',
        'type' => 'link',
        'og_group' => $group->nid
    );
    $link_node = $this->drupalCreateNode($link_node);
    $url = url('test_site/node/'.$link_node->nid);
    
    // Test that page returns 301 Redirect
    $this->drupalGet($url);
    $this->assertResponse(301, "A link node is viewed from outside a space, Redirect into space expected.");
    
    //Deeplink
    $url = url('test_site/node/'.$link_node->nid);
    // Test that page returns 200
    $this->drupalGet($url);
    $this->assertResponse(200, "A link node is viewed within a space, Valid Response expected.");
    
    //Add A Link
    $url = url('node/add/link');
    // Test that page returns 403 Access Denied
    $this->drupalGet($url);
    $this->assertResponse(403, "Adding a link when not in a space, Expect to be denided since this is space content, and the user does not have access.");
    
    //Add A Link
    $url = url('test_site/node/add/link');
    // Test that page returns 403 Access Denied
    $this->drupalGet($url);
    $this->assertResponse(403, "Adding a link when in a space and logged out, Expect to be denied access since you are not logged in.");
    
    // Create a user with access to add a link and login.
		$this->web_user = $this->drupalCreateUser(array('create link content'));
		$this->drupalLogin($this->web_user);
    
		//Add A Link
    $url = url('node/add/link');
    // Test that page returns 403 Access Denied
    $this->drupalGet($url);
    $this->assertResponse(403, "Adding a link when not in a space and logged in, Expect to be denided since this is space content.");
    
    //Add A Link
    $url = url('test_site/node/add/link');
    // Test that page returns 403 Access Denied
    $this->drupalGet($url);
    $this->assertResponse(403, "Adding a link when in a space, logged in, but not a site member, Expect to be denied access since you are not a member.");
    
    //Create A Group Node
    $group_node = array(
        'title' => 'Group 2',
        'type' => 'vsite',
        'purl' => 'group2',
        'uid' => $this->web_user->uid,
    );
    $group_node[OG_GROUP_FIELD][LANGUAGE_NONE][0]['value'] = 1;
    $group2 = $this->drupalCreateNode($group_node);
    
    //Add A Link
    $url = url('group2/node/add/link');
    
    // Assert the user is a group member.
    $this->assertTrue(og_is_member('node', $group2->nid, 'user', $this->web_user), t('Sanity check to make sure web_user was added as a group member.'));
    
    // Test that page returns 200 OK
    $this->drupalGet($url);
    $this->assertResponse(403, "Adding a link when in a space, logged in, and a site member, Expect to be granted access since this is space content.");
    
  }
}