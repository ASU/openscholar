<?php

/**
 * @file
 * Tests for Media Embed
 */

class MediaEmbedTests extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Media Embed',
      'desscription' => 'Tests for the embedding of iframes from a whitelisted domain',
      'group' => 'Openscholar WYSIWYG',
      'dependencies' => array('media_embed'),
    );
  }

  public function setUp() {
    parent::setUp();
    $whitelist = variable_get('media_embed_whitelist', array());
    $whitelist[] = 'test.com';
    variable_set('media_embed_whitelist', $whitelist);
  }

  public function testURLValid() {
    $iframe = '<iframe width="420" height="315" src="http://test.com/embed/bD0vcmhmaCY" frameborder="0" allowfullscreen></iframe>';
    $iframeSub = '<iframe width="420" height="315" src="http://anything.subdomain.test.com/embed/bD0vcmhmaCY" frameborder="0" allowfullscreen></iframe>';

    $this->assertTrue(media_embed_check_src($iframe), "Iframe with no subdomain.");
    $this->assertTrue(media_embed_check_src($iframeSub), "Iframe with a subdomain.");
  }

  public function testURLInvalid() {
    $iframe = '<iframe width="420" height="315" src="http://fail.com/embed/bD0vcmhmaCY" frameborder="0" allowfullscreen></iframe>';
    $iframeSub = '<iframe width="420" height="315" src="http://anything.subdomain.fail.com/embed/bD0vcmhmaCY" frameborder="0" allowfullscreen></iframe>';
    $iframeNotURL = '<iframe width="420" height="315" src="this_is_not_a_url" frameborder="0" allowfullscreen></iframe>';
    $notevenhtml = 'What is this mess? This isn\'t even in HTMl. It\'s just random text with some wierd characters in it. <¿¥>';

    $this->assertFalse(media_embed_check_src($iframe), "Iframe with no subdomain.");
    $this->assertFalse(media_embed_check_src($iframeSub), "Iframe with a subdomain.");
    $this->assertFalse(media_embed_check_src($iframeNotURL), "Iframe with bad url");
    $this->assertFalse(media_embed_check_src($notevenhtml), "Bad HTML");
  }

  public function testURLsInOtherThings() {
    $object = '<object width="420" height="315"><param name="movie" value="http://www.youtube.com/v/bD0vcmhmaCY?version=3&amp;hl=en_US"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/bD0vcmhmaCY?version=3&amp;hl=en_US" type="application/x-shockwave-flash" width="420" height="315" allowscriptaccess="always" allowfullscreen="true"></embed></object>';

  }

  public function tearDown() {
    parent::tearDown();
    $whitelist = variable_get('media_embed_whitelist', array());
    $whitelist = array_diff($whitelist, array('test.com'));
    variable_set('media_embed_whitelist', $whitelist);
  }

}