<?php 

function cp_appearance_menu() {
  $items = array();
  $items['cp/appearance'] = array(
    'title' => 'Appearance',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cp_appearance_theme_picker_form'),
    'weight' => 20,
  	'menu_name' => 'cp',
  	'access arguments' => array('access content'),
  );

  $items['cp/appearance/theme'] = array(
    'title' => t('Theme'),
    'page callback' => 'drupal_get_form',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  	'page arguments' => array('cp_appearance_theme_picker_form'),
    'weight' => 20,
  	'menu_name' => 'cp',
  	'access arguments' => array('access content'),
  );

  return $items;
}

function cp_appearance_theme() {
  $theme = array();

  $theme['cp-appearance-theme-item'] = array(
    'variables' => array('info' => array(), 'sub_theme' => ''),
    'template' => 'cp-appearance-theme-item',
    'path' => drupal_get_path('module', 'cp_appearance').'/theme',
  );

  $theme['cp_appearance_theme_picker_form'] = array(
    'render element' => 'form',
    'function' => 'theme_cp_appearance_theme_picker_form',
  );  
  
  return $theme;
}

function cp_appearance_theme_picker_form($form, &$state) {
  ctools_include('themes', 'os');
  $themes = os_get_themes();
  if (count($themes)) {
    ksort($themes);
  }
  //$flavors = os_theme_get_flavors();
  $radio_options = array(); //Radio Options
  

  $form = array(
    '#title' => t('Theme Picker'),
    '#theme' => array('cp_appearance_theme_picker_form'),
    '#submit' => array('cp_appearance_theme_picker_form_submit'),
  );
  
  foreach($themes as $theme) {
    $info = $theme->info;    
    $info['theme_name'] = $theme->name;
    $radio_options[$info['theme_name']] = $info['theme_name'];
    
    $theme_flavors = os_theme_get_flavors($theme->name);
    $elem = 'vsite_design_'.$info['theme_name'] . '_flavor';
    $default_flavor = '';
  
    $flavor_options = _cp_appearance_get_flavor_options($theme_flavors, $info, $default_flavor);
    if (count($flavor_options)) {
      $form[$elem] = array(
      	'#type' => 'select',
        '#title' => t('Flavor'),
        '#options' => $flavor_options,
        '#default_value' => variable_get($elem, $default_flavor),
      );

      //Screenshot callback
      if($info['screenshot'] && function_exists('ctools_ajax_associate_url_to_element')) {
        ctools_ajax_associate_url_to_element($form, $form[$elem], url('cp/settings/theme/swap_screenshot/'.$info['theme_name']),'ctools-use-ajax-onchange');
        // @TODO ajax menu http://api.drupal.org/api/drupal/includes%21ajax.inc/group/ajax/7
      }
    }
    
    $theme = os_theme_get(); //variable_get('vsite_design_maintheme', 'scholar_airstream');
//    if ($space = spaces_get_space() && isset($space->group->og_theme)) {
  //    $theme = $space->group->og_theme;
    //}
  
    //Move default theme to the front of the array
    if (isset($themes[$theme])){
  	  $default_theme = $themes[$theme];
  	  unset($themes[$theme]);
  	  $themes = array_merge(array($theme => $default_theme),$themes);  
    }
  
    $form['vsite_design_maintheme'] = array(
      '#enabled_themes' => $themes,
      '#type' => 'radios',
    	'#options' => $radio_options,
    	'#default_value' => $theme,
    	'#tree' => TRUE
    );
  }
  
  $form['reset'] = array(
    '#type' => 'submit',
    '#value' => t('Reset to defaults'),
  //  '#submit' => array('vsite_menus_settings_form_reset'),
  );
  
  $form = system_settings_form($form);
  
  return $form;
}

function cp_appearance_theme_picker_form_submit(&$form, &$form_state) {
  ctools_include('themes', 'os');
	$op = isset($form_state['values']['op']) ? $form_state['values']['op'] : '';
	
	if ($op != t('Reset to defaults')) {
	  os_theme_set($form_state['values']['vsite_design_maintheme']);
	} else {
	  os_theme_del();
	}
}

function _cp_appearance_get_flavor_options($theme_flavors, $info, &$default_flavor) {
  if (count($theme_flavors)) {
    $options = array(
    	'default' => ($info['flavor_name']) ? $info['flavor_name'] : t('Default') . t('(Default)'),
    );
    
    foreach ($theme_flavors as $key => $flavor) {
      if (isset($flavor['flavor_name'])) {
        $options[$key] = $flavor['flavor_name'];
        $default_flavor = $key;
      } else {
        $options[$key] = $flavor['name'];
      }
    }
  }
  
  return $options;
}



function theme_cp_appearance_theme_picker_form($variables) {
  $form = $variables['form']; //not sure why it isn't just passing me form.  @TODO debug
  $output = drupal_render($form['vsite_design_maintheme']);
  $items = array();  

  foreach ($form['vsite_design_maintheme']['#enabled_themes'] as $o_theme){
		$sub_theme = '';
		$a_info = array_merge((array)$o_theme->info, array('theme_name'=>$o_theme->name));

		//flavor screenshots
		if (array_key_exists('vsite_design_'.$o_theme->name.'_flavor', $form)){
			$sub_theme =  drupal_render($form['vsite_design_'.$o_theme->name.'_flavor']);

			if ($flavor = $form['vsite_design_'.$o_theme->name.'_flavor']['#default_value']){
				$theme_flavors = os_theme_get_flavors(); //vsite_design_get_flavors();

				if (array_key_exists($flavor, $theme_flavors) && array_key_exists('screenshot',$theme_flavors[$flavor]) && $theme_flavors[$flavor]['module'] == $o_theme->name){
				  $a_info['screenshot'] = $theme_flavors[$flavor]['path'] . '/' . $theme_flavors[$flavor]['screenshot'];
			  }
			}
		}

		//list of screenshots for each theme
		$items[] = array(
  		'class' => array(
  			'item-theme-picker', 
		    ($o_theme->name == $form['vsite_design_maintheme']['#default_value']) ? 'current' : ''  ),
			'id' => 'maintheme-'.str_replace('_','-',$o_theme->name),
		  'data' => theme('cp-appearance-theme-item', array('info'=>$a_info, 'sub_theme'=>$s_sub_theme)), 
    );
	}
	
	$output .= theme_item_list(array('items'=>$items, 'type'=>'ol', 'title'=>NULL, 'attributes'=>array()));
	unset($form['#theme']); //not sure how previous version got away without this...
	$output .= drupal_render($form);
  
	return $output;
}

/**
 * @author rbrandon
 *
 * Inform CTools that the flavor plugin can be loaded from themes and that
 * plugin implementors should use inf files instead of inc files (to keep PHP code from getting executed)
 */
function cp_appearance_ctools_plugin_type() {
  return array('flavor' => array(  
    'load themes' => true,
    'info file' => true,  //info file implies .info, rendering extension useless.  omitting it requires a hook. 
   // 'extension' => 'flav',
    'module' => 'os',
  ));
}