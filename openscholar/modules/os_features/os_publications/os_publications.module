<?php
// $Id$

/**
 * @file
 * Code for the os_publications feature.
 */

include_once 'os_publications.features.inc';

/**
 * Implements hook_os_app_info().
 */
function os_publications_os_app_info() {
  $apps = array();

  $apps['os_publications'] = array(
    'path' => 'publications',
    'importers' => array(
      'biblio' => array(
        'csv' => 'os_publication',
      ),
    ),
  );

  return $apps;
}

/**
 * Implements hook_os_add_new_links_alter().
 */
function os_publications_os_add_new_links_alter(&$links) {
  if (!in_array($_GET['q'], array('publications'))) {
    return;
  }

  $links['add_publication'] = array(
    'title' => t('publication'),
    'href' => 'biblio/add',
  );
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function os_publications_ctools_plugin_directory($module, $plugin) {
  if ($module == 'biblio') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_theme().
 */
function os_publications_theme() {
  $theme['os_publications_citeproc'] = array(
    'variables' => array(
      'id' => NULL,
      'image' => NULL,
      'citation' => NULL,
      'abstract' => NULL,
      'pdf_list' => NULL,
    ),
    'path' => drupal_get_path('module', 'os_publications') . '/templates',
    'template' => 'os-publications-citeproc',
  );

  return $theme;
}

/**
 * Implements hook_migrate_api_alter().
 *
 * Replace BiblioMigrateEntries with OS own implementation that maintains the
 * group audience field.
 *
 */
function os_publications_migrate_api_alter(&$info) {
  if (!db_table_exists('_biblio_1x')) {
    return;
  }

  $info['biblio']['migrations']['BiblioMigrateEntries'] = array('class_name' => 'OsBiblioMigrateEntries', 'group_name' => 'biblio_3');
}

/**
 * Implements hook_biblio_fields_info().
 */
function os_publications_biblio_fields_info() {
  // Add biblio_extra field to a Biblio entry.
  $items['biblio_extra'] = array(
    'field' => array(
      'active' => '1',
      'cardinality' => '-1',
      'entity_types' => array(),
      'field_name' => 'biblio_extra',
      'module' => 'dyntextfield',
      'settings' => array(
        'size' => '60',
      ),
      'translatable' => '0',
      'type' => 'dyntextfield',
    ),
    'instance' => array(
      'default_value' => NULL,
      'label' => 'Extra Fields',
      'description' => 'You may use these fields to add extra information about your publication that may not be common to publications if this type. For example, key "Publication Global ID" and value "http://hdl.handle.net/1902.1".',
      'required' => 0,
      'settings' => array(
        'user_register_form' => FALSE,
      ),
      'widget' => array(
        'active' => 1,
        'module' => 'dyntextfield',
        'settings' => array(),
        'type' => 'dyntextfield_widget',
        'weight' => '34',
      ),
    ),
  );

  return $items;
}

