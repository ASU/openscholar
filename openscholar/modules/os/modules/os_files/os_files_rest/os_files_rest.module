<?php

function os_files_rest_menu_alter(&$items) {
  $items['media/browser']['page callback'] = 'os_files_rest_media_browser';
}

function _os_files_rest_modify_response_row($file) {
  $blacklist = array(
    'og_group_ref' => TRUE,
    'og_membership' => TRUE,
    'og_membership__1' => TRUE,
    'og_membership__2' => TRUE,
    'og_membership__3' => TRUE,
    'og_group_ref__og_membership' => TRUE,
    'og_group_ref__og_membership__1' => TRUE,
    'og_group_ref__og_membership__2' => TRUE,
    'og_group_ref__og_membership__3' => TRUE,
  );

  $filtered = array_diff_key($file, $blacklist);

  $f = file_load($file['fid']);
  $filtered['orig'] = $f->origname;
  $filtered['preview'] = drupal_render(file_view_file($f, 'preview'));
  $filtered['form'] = array(
    'name' => 'textfield',
  );
  if ($filtered['type'] == 'image') {
    $filtered['form'] += array(
      'field_file_image_alt_text' => 'textfield',
      'field_file_image_title_text' => 'textfield',
    );
  }
  entity_get_controller('file')->resetCache();

  return $filtered;
}

function os_files_rest_media_browser() {
  $browser = array(
    '#prefix' => '<div ng-app="mediaBrowser">',
    '#suffix' => '</div>',
    '#attached' => array(
      'js' => array(
        array(
          'data' => 'https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.js',
          'type' => 'external',
        ),
        drupal_get_path('module', 'os_files_rest').'/misc/MediaBrowserModule.js',
      )
    )
  );

  return $browser;
}