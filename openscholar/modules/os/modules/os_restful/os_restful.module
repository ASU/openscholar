<?php

header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Headers: Authorization, access-token');

/**
 * Implements hook_ctools_plugin_directory().
 */
function os_restful_ctools_plugin_directory($module, $plugin) {
  if ($module == 'restful') {
    return 'plugins/' . $plugin;
  }
  if ($module == 'entity_validator') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_entity_property_info_alter().
 */
function os_restful_entity_property_info_alter(&$info) {
  $types = array('personal', 'project', 'department');

  foreach ($types as $type) {
    $info['node']['bundles'][$type]['properties']['preset'] = array(
      'label' => t('Site preset'),
      'setter callback' => 'os_restful_preset_set',
      'getter callback' => 'os_restful_preset_get',
    );

    $info['node']['bundles'][$type]['properties']['domain'] = array(
      'label' => t('Site purl'),
      'setter callback' => 'os_restful_purl_set',
      'getter callback' => 'os_restful_purl_get',
    );
  }

  $info['node']['bundles']['biblio']['properties']['biblio_type'] = array(
    'label' => t('Site purl'),
    'setter callback' => 'entity_property_verbatim_set',
    'getter callback' => 'entity_property_verbatim_get',
  );

  $entity_info = entity_get_info('node');
  foreach (array_keys($entity_info['bundles']) as $bundle) {
    $info['node']['bundles'][$bundle]['properties']['path'] = array(
      'label' => t('Site purl'),
      'setter callback' => 'os_restful_page_path_set',
      'getter callback' => 'os_restful_page_path_get',
      'type' => 'unknown',
    );
  }
}

/**
 * Set the node path.
 */
function os_restful_page_path_set(&$data, $name, $value, $langcode, $type, $info) {
  $data->$name = $value;
}

/**
 * Get the node path.
 */
function os_restful_page_path_get($data, array $options, $name, $type, $info) {
  if (empty($data->nid)) {
    return;
  }

  if ($path = path_load(array('source' => 'node/' . $data->nid))) {
    return $path['alias'];
  }

  return '';
}

/**
 * Set the preset og property.
 */
function os_restful_preset_set(&$data, $name, $value, $langcode, $type, $info) {
  $data->spaces_preset_og = $value;
}

/**
 * Get the og preset property.
 */
function os_restful_preset_get($data, array $options, $name, $type, $info) {
  if (!$space = vsite_get_vsite($data->nid)) {
    return NULL;
  }

  return $space->controllers->variable->get('spaces_preset_og');
}

/**
 * Set the purl property on the object.
 */
function os_restful_purl_set(&$data, $name, $value, $langcode, $type, $info) {
  $data->purl = $value;
}

/**
 * Return the value of the purl for the node.
 */
function os_restful_purl_get($data, array $options, $name, $type, $info) {
  return $data->purl;
}
