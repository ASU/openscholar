<?php

/**
 * @file
 * OS Revisions module file.
 */

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 */
function os_revisions_form_node_form_alter(&$form, $form_state) {
  $content_type = $form['#node']->type;

  if (!variable_get("enable_revisions_$content_type", FALSE)) {
    $form['revision_information']['#access'] = FALSE;
  }
}

/**
 * Implements hook_module_implements_alter().
 *
 * Removes purl from hook_init's implementations queue since it was already run
 * during custom_theme.
 */
function os_revisions_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_node_form_alter') {
    unset($implementations['os_revisions']);
    $implementations = array_merge(array('os_revisions' => FALSE), $implementations);
  }
}

/**
 * Implements hook_menu().
 */
function os_revisions_menu() {
  $items = array();
  $items['node/%node/revisions'] = array(
    'title' => 'Revisions',
    'page callback' => 'os_revisions_revision_overview',
    'page arguments' => array(1),
    'access callback' => '_node_revision_access',
    'access arguments' => array(1),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
  );
  
  return $items;
}

/**
 * Re-write the list of revisions for a node
 */
function os_revisions_revision_overview($node) {
  drupal_set_title(t('Revisions for %title', array('%title' => $node->title)), PASS_THROUGH);

  $header = array(t('Revision'), array('data' => t('Operations'), 'colspan' => 2));

  $revisions = node_revision_list($node);

  $rows = array();
  $revert_permission = FALSE;
  if ((user_access('revert revisions') || user_access('administer nodes')) && node_access('update', $node)) {
    $revert_permission = TRUE;
  }
  $delete_permission = FALSE;
  if ((user_access('delete revisions') || user_access('administer nodes')) && node_access('delete', $node)) {
    $delete_permission = TRUE;
  }
  foreach ($revisions as $revision) {
    $row = array();
    $operations = array();

    if ($revision->current_vid > 0) {
      $row[] = array('data' => t('!date by !username', array('!date' => format_date($revision->timestamp, 'short'), '!username' => theme('username', array('account' => $revision))))
        . (($revision->log != '') ? '<p class="revision-log">' . filter_xss($revision->log) . '</p>' : ''),
        'class' => array('revision-current'));
      $operations[] = array('data' => drupal_placeholder(t('current revision')), 'class' => array('revision-current'), 'colspan' => 2);
    }
    else {
      $row[] = t('!date by !username', array('!date' => format_date($revision->timestamp, 'short'), '!username' => theme('username', array('account' => $revision))))
        . (($revision->log != '') ? '<p class="revision-log">' . filter_xss($revision->log) . '</p>' : '');
      if ($revert_permission) {
        $operations[] = l(t('revert'), "node/$node->nid/revisions/$revision->vid/revert");
      }
      if ($delete_permission) {
        $operations[] = l(t('delete'), "node/$node->nid/revisions/$revision->vid/delete");
      }
    }
    $rows[] = array_merge($row, $operations);
  }

  $build['node_revisions_table'] = array(
    '#theme' => 'table',
    '#rows' => $rows,
    '#header' => $header,
  );

  return $build;
}

/**
 * Implements hook_form_alter().
 *
 * Add revision information in hidden fields and javascript to check if the user has reached the max # of revisions for the node
 */
function os_revisions_form_alter(&$form, &$form_state, $form_id){
  $node_edit_forms = array(
    'biblio_node_form',
    'blog_node_form',
    'book_node_form',
    'faq_node_form',
    'link_node_form',
    'news_node_form',
    'page_node_form',
    'person_node_form',
  );

  if (in_array($form_id, $node_edit_forms) && $form_state['node']->nid) {
    $max_revisions = (int)variable_get("restrict_node_revision_number_for_" . str_replace("-", "_", $form_state['node']->type), FALSE);
    if ($max_revisions) {
      $form['max_revisions'] = array('#type' => 'hidden', '#value' => $max_revisions);
      $form['revisions'] =  array('#type' => 'hidden', '#value' => count(node_revision_list(node_load($form_state['node']->nid))));
      $form['#attached']['js'][] = drupal_get_path('module', 'os_revisions') . '/os_revisions.js';
    }
  }
}